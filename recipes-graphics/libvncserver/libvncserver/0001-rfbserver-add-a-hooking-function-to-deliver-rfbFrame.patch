From 267c506ec08ab9304c9a4029fe928d8105e1a305 Mon Sep 17 00:00:00 2001
From: Jae Hyun Yoo <jae.hyun.yoo@linux.intel.com>
Date: Thu, 9 May 2019 15:33:55 -0700
Subject: [PATCH] rfbserver: add a hooking function to deliver
 rfbFramebufferUpdateRequest messages.

This commit adds a hooking function to deliver
rfbFramebufferUpdateRequest messages from clients to the frame
producer for a case the producer needs to handle the messages for
flow control or etc.
---
 libvncserver/rfbserver.c | 6 ++++--
 rfb/rfb.h                | 5 +++++
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/libvncserver/rfbserver.c b/libvncserver/rfbserver.c
index 42209cf29a0d..f9456bab383b 100644
--- a/libvncserver/rfbserver.c
+++ b/libvncserver/rfbserver.c
@@ -2380,8 +2380,10 @@ rfbProcessClientNormalMessage(rfbClientPtr cl)
 	        rfbLog("Warning, ignoring rfbFramebufferUpdateRequest: %dXx%dY-%dWx%dH\n",msg.fur.x, msg.fur.y, msg.fur.w, msg.fur.h);
 		return;
         }
- 
-        
+
+        if (cl->clientFURHook)
+            cl->clientFURHook(cl, &msg.fur);
+
 	tmpRegion =
 	  sraRgnCreateRect(msg.fur.x,
 			   msg.fur.y,
diff --git a/rfb/rfb.h b/rfb/rfb.h
index 2a5600e25375..1a2294428288 100644
--- a/rfb/rfb.h
+++ b/rfb/rfb.h
@@ -412,6 +412,8 @@ typedef struct sraRegion* sraRegionPtr;
  */
 
 typedef void (*ClientGoneHookPtr)(struct _rfbClientRec* cl);
+typedef void (*ClientFURHookPtr)(struct _rfbClientRec* cl,
+                                 rfbFramebufferUpdateRequestMsg* furMsg);
 
 typedef struct _rfbFileTransferData {
   int fd;
@@ -457,6 +459,9 @@ typedef struct _rfbClientRec {
     void* clientData;
     ClientGoneHookPtr clientGoneHook;
 
+    /** clientFURHook is called when a client requests a frame buffer update. */
+    ClientFURHookPtr clientFURHook;
+
     SOCKET sock;
     char *host;
 
-- 
2.7.4

